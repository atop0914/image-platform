<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½“å¤©å›¾åº“ - å›¾ç‰‡å¹³å°</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; padding: 24px; }
        .gallery-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.08); transition: all 0.3s; }
        .gallery-card:hover { transform: translateY(-6px); box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
        .gallery-card img { width: 100%; height: 280px; object-fit: cover; cursor: pointer; }
        .gallery-card-body { padding: 16px; }
        .gallery-card-title { font-size: 14px; color: #1f2937; margin-bottom: 10px; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .gallery-card-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
        .platform-badge { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .model-badge { background: linear-gradient(135deg, #10b981, #34d399); color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .publish-btn { width: 100%; padding: 10px; background: linear-gradient(135deg, #f59e0b, #fbbf24); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .publish-btn:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4); }
        .publish-btn:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }
        .date-input { padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.2s; }
        .date-input:focus { border-color: #6366f1; outline: none; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; background: white; border-bottom: 1px solid #e5e7eb; }
        .stats-bar { display: flex; gap: 24px; padding: 16px 24px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        .stat-item { display: flex; align-items: center; gap: 8px; }
        .stat-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .stat-value { font-size: 20px; font-weight: 700; }
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="logo">
                <span class="logo-icon">ğŸ–¼ï¸</span>
                <span class="logo-text">å›¾ç‰‡å¹³å°</span>
            </div>
            <nav class="nav">
                <a href="/" class="nav-item">
                    <span class="nav-icon">ğŸ“‹</span>
                    <span>å¾…å®¡æ ¸</span>
                    <span class="badge" id="pendingBadge">0</span>
                </a>
                <a href="/records" class="nav-item">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span>å®¡æ ¸è®°å½•</span>
                </a>
                <a href="/gallery" class="nav-item active">
                    <span class="nav-icon">ğŸ–¼ï¸</span>
                    <span>å½“å¤©å›¾åº“</span>
                </a>
                <a href="/add" class="nav-item">
                    <span class="nav-icon">â•</span>
                    <span>æ·»åŠ å›¾ç‰‡</span>
                </a>
            </nav>
        </aside>

        <main class="main" style="margin-left: 240px;">
            <div class="header">
                <h1 style="font-size: 24px; font-weight: 700;">ğŸ“¸ å½“å¤©å›¾åº“</h1>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <input type="date" id="datePicker" class="date-input" value="{{ .date }}">
                    <button class="btn btn-primary" onclick="loadGallery()">ğŸ” æŸ¥çœ‹</button>
                </div>
            </div>

            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-icon" style="background: #dbeafe;">ğŸ–¼ï¸</div>
                    <div>
                        <div class="stat-value" style="color: #2563eb;">{{ .total }}</div>
                        <div style="font-size: 12px; color: #6b7280;">å›¾ç‰‡æ€»æ•°</div>
                    </div>
                </div>
            </div>

            <div class="gallery-grid" id="galleryGrid">
                {{ range .records }}
                <div class="gallery-card">
                    <img src="{{ .Path }}" alt="{{ .Name }}" onclick="previewImage('{{ .Path }}')">
                    <div class="gallery-card-body">
                        <div class="gallery-card-title" title="{{ .Prompt }}">{{ .Prompt }}</div>
                        <div class="gallery-card-meta">
                            <span class="platform-badge">{{ .Platform }}</span>
                            <span class="model-badge">{{ .Model }}</span>
                        </div>
                        <button class="publish-btn" onclick="publishImage({{ .ID }}, '{{ .Prompt }}')">ğŸ“¤ ä¸€é”®å‘å¸ƒ</button>
                    </div>
                </div>
                {{ end }}
            </div>
            
            {{ if eq .total 0 }}
            <div style="text-align: center; padding: 60px; color: #9ca3af;">
                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“­</div>
                <div style="font-size: 18px;">å½“å¤©è¿˜æ²¡æœ‰å®¡æ ¸é€šè¿‡çš„å›¾ç‰‡</div>
            </div>
            {{ end }}
        </main>
    </div>

    <!-- å‘å¸ƒå¼¹çª— -->
    <div id="publishModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index: 1000;">
        <div style="background:white; padding:28px; border-radius:16px; width:480px; max-width:95%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="margin: 0 0 20px 0; font-size: 20px;">ğŸ“¤ å‘å¸ƒåˆ°å¤šå¹³å°</h2>
            
            <div class="form-group">
                <label style="display:block; margin-bottom:6px; font-weight:500; color:#374151;">æ ‡é¢˜</label>
                <input type="text" id="publishTitle" class="input" placeholder="è¾“å…¥æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰" style="width:100%; box-sizing:border-box;">
            </div>
            
            <div class="form-group">
                <label style="display:block; margin-bottom:6px; font-weight:500; color:#374151;">æ­£æ–‡å†…å®¹</label>
                <textarea id="publishContent" class="textarea" rows="4" placeholder="è¾“å…¥æ­£æ–‡å†…å®¹ï¼ˆå¯é€‰ï¼‰" style="width:100%; box-sizing:border-box;"></textarea>
            </div>
            
            <div class="form-group">
                <label style="display:block; margin-bottom:8px; font-weight:500; color:#374151;">é€‰æ‹©å¹³å°</label>
                <div id="platformList" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
            </div>
            
            <!-- å‘å¸ƒç»“æœ -->
            <div id="publishResult" style="display:none; margin-top: 16px; padding: 16px; border-radius: 12px; background: #f9fafb;">
                <div style="font-weight: 600; margin-bottom: 12px;">ğŸ“Š å‘å¸ƒç»“æœ</div>
                <div id="resultList"></div>
            </div>
            
            <div style="display:flex; gap:12px; justify-content:flex-end; margin-top: 20px;">
                <button class="btn btn-default" onclick="closePublishModal()" id="cancelBtn">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmPublish()" id="publishBtn">ğŸš€ ç«‹å³å‘å¸ƒ</button>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆ -->
    <div id="previewModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); align-items:center; justify-content:center; z-index: 1001;" onclick="this.style.display='none'">
        <img id="previewImg" style="max-width:90%; max-height:90%; border-radius:8px;">
    </div>

    <script>
        let currentImageId = null;
        let currentPrompt = '';
        let availablePlatforms = [];

        async function loadPlatforms() {
            try {
                const res = await fetch('/api/platforms');
                const data = await res.json();
                availablePlatforms = data.platforms || [];
                renderPlatforms();
            } catch (e) {
                console.error(e);
            }
        }

        function renderPlatforms() {
            const container = document.getElementById('platformList');
            if (availablePlatforms.length === 0) {
                container.innerHTML = '<span style="color:#9ca3af;">æš‚æ— å¯ç”¨å‘å¸ƒå¹³å°ï¼Œè¯·é…ç½®</span>';
                return;
            }
            container.innerHTML = availablePlatforms.map(p => 
                `<label style="display:inline-flex; align-items:center; gap:6px; padding:8px 14px; background:#f3f4f6; border-radius:20px; cursor:pointer; transition:all 0.2s;">
                    <input type="checkbox" value="${p.type}" checked style="accent-color:#6366f1;">
                    <span>${p.name}</span>
                </label>`
            ).join('');
        }

        function loadGallery() {
            const date = document.getElementById('datePicker').value;
            location.href = '/gallery?date=' + date;
        }

        function previewImage(src) {
            document.getElementById('previewImg').src = src;
            document.getElementById('previewModal').style.display = 'flex';
        }

        function publishImage(id, prompt) {
            currentImageId = id;
            currentPrompt = prompt || '';
            document.getElementById('publishTitle').value = currentPrompt.slice(0, 50);
            document.getElementById('publishContent').value = '';
            document.getElementById('publishResult').style.display = 'none';
            document.getElementById('publishModal').style.display = 'flex';
        }

        function closePublishModal() {
            document.getElementById('publishModal').style.display = 'none';
            currentImageId = null;
        }

        async function confirmPublish() {
            if (!currentImageId) return;

            const title = document.getElementById('publishTitle').value;
            const content = document.getElementById('publishContent').value;
            const platforms = Array.from(document.querySelectorAll('#platformList input:checked')).map(cb => cb.value);

            if (platforms.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå‘å¸ƒå¹³å°');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const btn = document.getElementById('publishBtn');
            btn.disabled = true;
            btn.textContent = 'å‘å¸ƒä¸­...';

            try {
                const res = await fetch('/api/publish', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        image_id: currentImageId,
                        platforms: platforms,
                        title: title,
                        content: content
                    })
                });
                const data = await res.json();
                
                // æ˜¾ç¤ºç»“æœ
                const resultDiv = document.getElementById('publishResult');
                const resultList = document.getElementById('resultList');
                resultDiv.style.display = 'block';
                
                let successCount = 0;
                let html = '';
                for (const [platform, result] of Object.entries(data.results || {})) {
                    const isSuccess = !result.startsWith('å¤±è´¥');
                    if (isSuccess) successCount++;
                    html += `<div style="display:flex; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid #e5e7eb;">
                        <span style="font-size:18px;">${isSuccess ? 'âœ…' : 'âŒ'}</span>
                        <span style="font-weight:500;">${platform}:</span>
                        <span style="color:${isSuccess ? '#10b981' : '#ef4444'}; flex:1;">${result}</span>
                    </div>`;
                }
                resultList.innerHTML = html;
                
                btn.textContent = successCount === platforms.length ? 'ğŸ‰ å…¨éƒ¨æˆåŠŸ' : 'âš ï¸ éƒ¨åˆ†å¤±è´¥';

            } catch (e) {
                alert('å‘å¸ƒå¤±è´¥: ' + e.message);
                btn.disabled = false;
                btn.textContent = 'ğŸš€ ç«‹å³å‘å¸ƒ';
            }
        }

        loadPlatforms();
    </script>
</body>
</html>
