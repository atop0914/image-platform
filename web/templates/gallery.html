<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½“å¤©å›¾åº“ - å›¾ç‰‡å¹³å°</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; padding: 20px; }
        .gallery-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .gallery-card:hover { transform: translateY(-4px); box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
        .gallery-card img { width: 100%; height: 250px; object-fit: cover; }
        .gallery-card-body { padding: 12px; }
        .gallery-card-title { font-size: 14px; color: #333; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .gallery-card-meta { font-size: 12px; color: #666; display: flex; gap: 8px; flex-wrap: wrap; }
        .platform-badge { background: #6366f1; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
        .model-badge { background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
        .publish-btn { width: 100%; margin-top: 8px; }
        .date-input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; }
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="logo">
                <span class="logo-icon">ğŸ–¼ï¸</span>
                <span class="logo-text">å›¾ç‰‡å¹³å°</span>
            </div>
            <nav class="nav">
                <a href="/" class="nav-item">
                    <span class="nav-icon">ğŸ“‹</span>
                    <span>å¾…å®¡æ ¸</span>
                </a>
                <a href="/records" class="nav-item">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span>å®¡æ ¸è®°å½•</span>
                </a>
                <a href="/gallery" class="nav-item active">
                    <span class="nav-icon">ğŸ–¼ï¸</span>
                    <span>å½“å¤©å›¾åº“</span>
                </a>
                <a href="/add" class="nav-item">
                    <span class="nav-icon">â•</span>
                    <span>æ·»åŠ å›¾ç‰‡</span>
                </a>
            </nav>
        </aside>

        <main class="main">
            <header class="header">
                <h1>å½“å¤©å›¾åº“</h1>
                <div class="header-actions">
                    <input type="date" id="datePicker" class="date-input" value="{{ .date }}">
                    <button class="btn btn-primary" onclick="loadGallery()">æŸ¥çœ‹</button>
                </div>
            </header>

            <div class="content">
                <p style="padding: 20px;">å…± {{ .total }} å¼ å®¡æ ¸é€šè¿‡çš„å›¾ç‰‡</p>
                <div class="gallery-grid" id="galleryGrid">
                    {{ range .records }}
                    <div class="gallery-card">
                        <img src="{{ .Path }}" alt="{{ .Name }}">
                        <div class="gallery-card-body">
                            <div class="gallery-card-title" title="{{ .Prompt }}">{{ .Prompt }}</div>
                            <div class="gallery-card-meta">
                                <span class="platform-badge">{{ .Platform }}</span>
                                <span class="model-badge">{{ .Model }}</span>
                            </div>
                            <button class="btn btn-primary publish-btn" onclick="publishImage({{ .ID }})">ğŸ“¤ å‘å¸ƒ</button>
                        </div>
                    </div>
                    {{ end }}
                </div>
            </div>
        </main>
    </div>

    <!-- å‘å¸ƒå¼¹çª— -->
    <div id="publishModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
        <div style="background:white; padding:24px; border-radius:12px; width:400px; max-width:90%;">
            <h3>ğŸ“¤ å‘å¸ƒå›¾ç‰‡</h3>
            <div class="form-group">
                <label>æ ‡é¢˜</label>
                <input type="text" id="publishTitle" class="input" placeholder="è¾“å…¥æ ‡é¢˜">
            </div>
            <div class="form-group">
                <label>å†…å®¹</label>
                <textarea id="publishContent" class="textarea" rows="4" placeholder="è¾“å…¥æ­£æ–‡å†…å®¹"></textarea>
            </div>
            <div class="form-group">
                <label>å‘å¸ƒå¹³å°</label>
                <div id="platformList"></div>
            </div>
            <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button class="btn btn-default" onclick="closePublishModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmPublish()">å‘å¸ƒ</button>
            </div>
        </div>
    </div>

    <script>
        let currentImageId = null;
        let availablePlatforms = [];

        // åŠ è½½å¹³å°åˆ—è¡¨
        async function loadPlatforms() {
            try {
                const res = await fetch('/api/platforms');
                const data = await res.json();
                availablePlatforms = data.platforms;
                renderPlatforms();
            } catch (e) {
                console.error(e);
            }
        }

        function renderPlatforms() {
            const container = document.getElementById('platformList');
            if (availablePlatforms.length === 0) {
                container.innerHTML = '<p style="color:#666;">æš‚æ— å¯ç”¨å¹³å°</p>';
                return;
            }
            container.innerHTML = availablePlatforms.map(p => 
                `<label style="display:inline-flex; align-items:center; gap:4px; margin-right:12px;">
                    <input type="checkbox" value="${p.type}" checked> ${p.name}
                </label>`
            ).join('');
        }

        function loadGallery() {
            const date = document.getElementById('datePicker').value;
            location.href = '/gallery?date=' + date;
        }

        function publishImage(id) {
            currentImageId = id;
            document.getElementById('publishModal').style.display = 'flex';
        }

        function closePublishModal() {
            document.getElementById('publishModal').style.display = 'none';
            currentImageId = null;
        }

        async function confirmPublish() {
            if (!currentImageId) return;

            const title = document.getElementById('publishTitle').value;
            const content = document.getElementById('publishContent').value;
            
            // è·å–é€‰ä¸­çš„å¹³å°
            const platforms = Array.from(document.querySelectorAll('#platformList input:checked')).map(cb => cb.value);

            try {
                const res = await fetch('/api/publish', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        image_id: currentImageId,
                        platforms: platforms,
                        title: title,
                        content: content
                    })
                });
                const data = await res.json();
                
                if (res.ok) {
                    let msg = 'å‘å¸ƒç»“æœ:\n';
                    for (const [platform, result] of Object.entries(data.results)) {
                        msg += `${platform}: ${result}\n`;
                    }
                    alert(msg);
                    closePublishModal();
                } else {
                    alert('å‘å¸ƒå¤±è´¥: ' + data.error);
                }
            } catch (e) {
                alert('å‘å¸ƒå¤±è´¥: ' + e.message);
            }
        }

        loadPlatforms();
    </script>
</body>
</html>
